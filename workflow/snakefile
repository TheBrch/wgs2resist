import glob, os, shutil

configfile: os.path.join("config", "config.yaml")

env_dir = os.path.join("..", "envs")
suscept = config["suscept_table"]
gpam = config["gpam_table"]
metadata = config["metadata"]
assembly_dir = config["assembly_dir"]
models = config["models"].split()
gene_aln_dir = config["core_gene_aln_dir"]

script_dir = os.path.join("workflow", "scripts")

def get_file(i):
    with open(metadata, "r") as f:
        for line in f:
            fields = line.strip().split("\t")
            if i in fields[1]:
                return fields[2]
        return i 

with open(suscept, "r") as f:
	first_line = f.readline().strip().split()
	ids = first_line[1:]

fastapaths = {
    i: os.path.abspath(os.path.join(assembly_dir, true_id, f"{true_id}_filtered.fasta"))
    for i in ids
    if (true_id := get_file(i))
}

gene_files = glob.glob(os.path.join(gene_aln_dir, "*.aln.fas"))

rule all:
    input:
        # lambda x: expand(
        #     os.path.join("results", "models", "{ab}", "{model}.pkl"),
        #     ab = get_antibiotics(),
        #     model = models,
        # ),
        lambda x: expand(
            os.path.join("results", "models", "{ab}", "stats", "figs", "{ab}_pr.png"),
            ab = get_antibiotics(),
        ),
        os.path.join("results", "models", "combined_metrics_summary.png")
        # os.path.join("results", "reference.fa")
        # os.path.join("results", "ns-snippy-core", "non-synonymous-core.tsv"),
        # os.path.join("results", "unitig-caller", "unitigs.rtab")


include: "rules/condense.smk"
include: "rules/encode.smk"
include: "rules/evaluate.smk"
include: "rules/train.smk"
include: "rules/snp.smk"
include: "rules/unitig.smk"


def get_antibiotics():
    reformat_dir = checkpoints.reformat.get().output[0]
    r_tsvs = glob.glob(os.path.join(reformat_dir, "*.tsv"))
    antibiotics = []
    for table in r_tsvs:
        filename = table.split(os.sep)[-1]
        match = re.match(r"(.+)\.tsv", filename)
        if match:
            name_part = match.groups()[0]
            antibiotics.append(name_part)
    return antibiotics
